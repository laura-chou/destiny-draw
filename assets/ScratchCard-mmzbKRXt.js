import{al as W,Y as A,av as Y,f as p,aA as $,n as I,G as u,aq as R,am as X,an as P,ao as o,ap as j,z as v,aw as T,au as q,at as D,ar as b,c as M,H as E,az as F}from"./index-DiTNGkJu.js";import{_ as N,V as B,a as G,b as O,c as H}from"./_plugin-vue_export-helper-CeApmRvS.js";import{V as U}from"./VDialog-CQBwlFGj.js";const J={class:"scratch-content"},K=["width","height"],L=W({__name:"CustomScratchCard",props:{width:{},height:{},coverColor:{},finishPercent:{}},emits:["complete"],setup(m,{expose:z,emit:g}){const t=m,x=g,l=u(null),e=u(null),w=u(!1),i=u(!1),_=()=>{l.value&&(e.value=l.value.getContext("2d",{willReadFrequently:!0}),e.value&&(e.value.fillStyle=t.coverColor||"#C0C0C0",e.value.fillRect(0,0,t.width,t.height),e.value.fillStyle="#999",e.value.font="20px Arial",e.value.textAlign="center",e.value.fillText("刮開有獎",t.width/2,t.height/2+7),e.value.globalCompositeOperation="destination-out",e.value.lineWidth=25,e.value.lineCap="round"))},C=a=>{if(!l.value)return{x:0,y:0};const s=l.value.getBoundingClientRect(),d="touches"in a?a.touches[0].clientX:a.clientX,h="touches"in a?a.touches[0].clientY:a.clientY;return{x:d-s.left,y:h-s.top}},y=a=>{var h,c;if(i.value)return;w.value=!0;const{x:s,y:d}=C(a);(h=e.value)==null||h.beginPath(),(c=e.value)==null||c.moveTo(s,d)};let k=0;const V=a=>{var c,S;if(!w.value||i.value)return;a.preventDefault();const{x:s,y:d}=C(a);(c=e.value)==null||c.lineTo(s,d),(S=e.value)==null||S.stroke();const h=Date.now();h-k>200&&(k=h,n())},f=()=>{w.value=!1,n()},n=()=>{if(!e.value||i.value)return;const s=e.value.getImageData(0,0,t.width,t.height).data;let d=0;for(let c=3;c<s.length;c+=4)s[c]===0&&d++;d/(t.width*t.height)*100>=(t.finishPercent||50)&&r()},r=()=>{!e.value||i.value||(i.value=!0,e.value.globalCompositeOperation="destination-out",e.value.fillRect(0,0,t.width,t.height),x("complete"))};return A(()=>{_()}),z({reset:()=>{i.value=!1,_()}}),(a,s)=>(R(),Y("div",{class:"scratch-card-wrapper",style:I({width:m.width+"px",height:m.height+"px"})},[p("div",J,[$(a.$slots,"default",{},void 0)]),p("canvas",{class:"scratch-canvas",ref_key:"canvasRef",ref:l,width:m.width,height:m.height,onMousedown:y,onMousemove:V,onMouseup:f,onTouchstart:y,onTouchmove:V,onTouchend:f},null,40,K)],4))}}),Q=N(L,[["__scopeId","data-v-6d9fd16e"]]),Z={class:"scratch-container mb-4 mb-sm-6"},ee={class:"prize-reveal-area"},te={class:"prize-text"},ae={class:"text-h4 font-weight-black text-grey-darken-3"},ne=W({__name:"ScratchCard",setup(m){const z=F(),g=X(),t=u(null),x=u(!1),l=u(!1),e=u(!1),w=u(null),i=M(()=>typeof window<"u"?Math.min(window.innerWidth-65,400):400),_=M(()=>i.value-(window.innerWidth<600?45:60)),C=()=>{const f=g.availablePrizes;f.length>0&&(t.value=f[Math.floor(Math.random()*f.length)])},y=()=>{x.value=!0,l.value=!0,t.value&&g.recordWin(t.value.name,t.value.id)},k=async()=>{e.value=!0,x.value=!1,C(),await E(),e.value=!1},V=()=>{l.value=!1,g.availablePrizes.length<2&&z.push("/settings")};return A(()=>{C()}),(f,n)=>(R(),P(j,{class:"d-flex flex-column align-center justify-center pa-0"},{default:o(()=>[v(B,{class:"mx-auto pa-4 pa-sm-6 scratch-outer-card",elevation:"10",rounded:"xl","max-width":i.value},{default:o(()=>[p("div",Z,[e.value?q("",!0):(R(),P(Q,{key:0,ref_key:"scratchCardRef",ref:w,width:_.value,height:180,finishPercent:30,onComplete:y},{default:o(()=>{var r;return[p("div",ee,[p("div",te,T((r=t.value)==null?void 0:r.name),1)])]}),_:1},8,["width"]))]),v(D,{class:"elevation-4",color:"deep-orange-darken-4",size:"x-large",onClick:k,disabled:!x.value,block:"",rounded:"pill"},{default:o(()=>[...n[1]||(n[1]=[b("再玩一次",-1)])]),_:1},8,["disabled"])]),_:1},8,["max-width"]),v(U,{modelValue:l.value,"onUpdate:modelValue":n[0]||(n[0]=r=>l.value=r),"max-width":"320",persistent:""},{default:o(()=>[v(B,{class:"rounded-xl pa-4"},{default:o(()=>[v(G,{class:"text-center text-h5 font-weight-bold text-deep-orange"},{default:o(()=>[...n[2]||(n[2]=[b("恭喜",-1)])]),_:1}),v(O,{class:"text-center py-6"},{default:o(()=>{var r;return[p("div",ae,T((r=t.value)==null?void 0:r.name),1)]}),_:1}),v(H,{class:"justify-center"},{default:o(()=>[v(D,{color:"deep-orange-darken-2",variant:"elevated",size:"large",rounded:"pill",width:"160",onClick:V},{default:o(()=>[...n[3]||(n[3]=[b("確定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}}),ie=N(ne,[["__scopeId","data-v-82d816cf"]]);export{ie as default};
